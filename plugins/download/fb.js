// file: plugins/downloader/facebook.js
import fetch from "node-fetch";

const fbDownloaderHandler = async (m, { sock, text }) => {
    const jid = m.key.remoteJid;

    if (!text) {
        return await sock.sendMessage(jid, { 
            text: `‚ùó Masukkan URL Video Facebook/Reels.\nContoh: ${global.prefix}fb https://www.facebook.com/watch/?v=xxxx` 
        }, { quoted: m });
    }

    await sock.sendMessage(jid, { text: "‚è≥ Sedang mengambil data video Facebook..." }, { quoted: m });

    try {
        const apiUrl = `https://api.ootaizumi.web.id/downloader/facebook?url=${encodeURIComponent(text)}`;
        const res = await fetch(apiUrl);
        const data = await res.json();

        if (data.status && data.result) {
            const { thumbnail, downloads } = data.result;

            // Cari kualitas HD (720p), jika tidak ada ambil yang pertama tersedia
            const videoData = downloads.find(v => v.quality.includes("HD")) || downloads[0];

            if (!videoData || !videoData.url) {
                return await sock.sendMessage(jid, { text: "‚ùå Gagal mendapatkan link download." }, { quoted: m });
            }

            // Kirim Video
            await sock.sendMessage(jid, { 
                video: { url: videoData.url },
                caption: `‚úÖ *FACEBOOK DOWNLOADER SUCCESS*\n\nüì∫ *Quality:* ${videoData.quality}\n\n_Generated by ${global.botName}_`,
                mimetype: 'video/mp4',
                fileName: `fb_video.mp4`
            }, { quoted: m });

        } else {
            await sock.sendMessage(jid, { text: "‚ùå Video tidak ditemukan atau link tidak valid." }, { quoted: m });
        }
    } catch (e) {
        console.error("[FB DOWNLOADER ERROR]", e);
        await sock.sendMessage(jid, { text: "‚ùå Terjadi kesalahan saat memproses permintaan." }, { quoted: m });
    }
};

fbDownloaderHandler.help = ['fb', 'facebook'];
fbDownloaderHandler.tags = ['downloader'];
fbDownloaderHandler.command = /^(fb|facebook|fbdl)$/i;

export default fbDownloaderHandler;